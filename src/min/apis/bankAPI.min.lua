local a={}local b=require("itemManager")local function c(d,e,f)fs.delete("account/"..d)local g=fs.open("account/"..d,"w")g.writeLine(e)g.writeLine(f)g.close()end;local h={}local function i(d,j)local k=os.time()h[d]={digitalIDs=j,timestamp=k}end;local function l(d)if h[d]then local m=h[d]local g=fs.open("account/"..d,"r")local n=tonumber(g.readLine())local o=g.readLine()g.close()local p=b.materializeItems(m.digitalIDs)n=n+p;c(d,n,o)h[d]=nil;return true,"Transaction reverted"else return false,"No pending transaction found"end end;local function q()while true do local r=os.time()for d,m in pairs(h)do if r-m.timestamp>CONFIG.TRANSACTION_TIMEOUT then l(d)print("Withdraw for account "..d.." reverted")end end;sleep(5)end end;parallel.waitForAny(q)function a.confirmTransaction(d)if h[d]then h[d]=nil end end;function a.deposit(d,j,f)local g=fs.open("account/"..d,"r")if g~=nil then local s=tonumber(g.readLine())local n=s;local o=g.readLine()g.close()if f==o then local t,u=pcall(function()return b.materializeItems(j)end)if not t then local v=u:match(":%d+: (.+)")or u;if v=="Bank is full!"then return false,v else print(u)return false,"Unknown Server Error"end else n=n+u*CONFIG.EXCHANGERATE;c(d,n,o)return true,n,s end else return false,"Incorrect Pin"end end end;function a.withdraw(d,p,f)local g=fs.open("account/"..d,"r")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()g.close()if f==o then if n>=p then local t,u=pcall(function()return b.digitizeAmount(p)end)if not t then local v=u:match(":%d+: (.+)")or u;if v=="Bank is too poor!"then return false,v else print(u)return false,"Unknown Server Error"end else n=n-p;c(d,n,o)i(d,u)return true,u,n end else return false,"Insufficient Funds"end else return false,"Incorrect Pin"end end end;function a.getBalance(d,f)local g=fs.open("account/"..d,"r")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()g.close()if f==o then return true,n else return false,"Incorrect Pin"end end end;function a.transfer(d,p,w,f)if d==w then return false,"Cannot transfer to the same account"end;local g=fs.open("account/"..d,"r+")local x=fs.open("account/"..w,"r+")if g~=nil and x~=nil then local n=tonumber(g.readLine())local o=g.readLine()local y=tonumber(x.readLine())local z=x.readLine()if f==o then if n>=p then n=n-p;y=y+p;c(d,n,o)c(d,y,z)g.close()x.close()return true,n else return false,"Insufficient Funds"end else return false,"Incorrect Pin"end end end;function a.checkPin(d,f)local A=false;if not d or not f then return A end;local g=fs.open("account/"..d,"r+")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()if f==o then A=true end;g.close()return A else return false end end;function a.checkCard(d)local A=false;if not d then return A end;local g=fs.open("account/"..d,"r")if g~=nil then A=true;g.close()end;return A end;function a.createAccount(d,f)if not d or not f then return false,"Account number and PIN are required"end;local g=nil;g=fs.open("account/"..d,"r")if g~=nil then g.close()return false,"Account already exists"end;local e=0;g=fs.open("account/"..d,"w")g.writeLine(e)g.writeLine(f)g.close()return true,"Account created successfully"end;return a
