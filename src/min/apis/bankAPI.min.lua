local a={}local b=require("itemManager")local function c(d,e,f)fs.delete("account/"..d)local g=fs.open("account/"..d,"w")g.writeLine(e)g.writeLine(f)g.close()end;local h={}local function i(d,j)local k=os.time(os.date("*t"))h[d]={digitalIDs=j,timestamp=k}end;local function l(d)if h[d]then local m=h[d]local g=fs.open("account/"..d,"r")local n=tonumber(g.readLine())local o=g.readLine()g.close()local p=b.materializeItems(m.digitalIDs)if not tonumber(p)then return false,"Error while reverting transaction"end;n=n+p*CONFIG.EXCHANGERATE;c(d,n,o)h[d]=nil;return true,"Transaction reverted"else return false,"No pending transaction found"end end;function a.checkPendingTransactions()while true do local q=os.time(os.date("*t"))for d,m in pairs(h)do if q-m.timestamp>CONFIG.TRANSACTION_TIMEOUT then local r,s=l(d)if not r then print(s)else print("Withdraw for account "..d.." reverted")end end end;sleep(5)end end;function a.confirmTransaction(d)if h[d]then h[d]=nil end end;function a.deposit(d,j,f)local g=fs.open("account/"..d,"r")if g~=nil then local t=tonumber(g.readLine())local n=t;local o=g.readLine()g.close()if f==o then local r,s=pcall(function()return b.materializeItems(j)end)if not r then local u=s:match(":%d+: (.+)")or s;if u=="Bank is full!"then return false,u else print(s)return false,"Unknown Server Error"end else n=n+s*CONFIG.EXCHANGERATE;c(d,n,o)return true,n,t end else return false,"Incorrect Pin"end end end;function a.withdraw(d,p,f)local g=fs.open("account/"..d,"r")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()g.close()if f==o then if n>=p then local r,s=pcall(function()return b.digitizeAmount(p)end)if not r then local u=s:match(":%d+: (.+)")or s;if u=="Bank is too poor!"then return false,u else print(s)return false,"Unknown Server Error"end else n=n-p*CONFIG.EXCHANGERATE;c(d,n,o)i(d,s)return true,s,n end else return false,"Insufficient Funds"end else return false,"Incorrect Pin"end end end;function a.getBalance(d,f)local g=fs.open("account/"..d,"r")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()g.close()if f==o then return true,n else return false,"Incorrect Pin"end end end;function a.transfer(d,p,v,f)if d==v then return false,"Cannot transfer to the same account"end;local g=fs.open("account/"..d,"r+")local w=fs.open("account/"..v,"r+")if g~=nil and w~=nil then local n=tonumber(g.readLine())local o=g.readLine()local x=tonumber(w.readLine())local y=w.readLine()if f==o then if n>=p then n=n-p;x=x+p;c(d,n,o)c(d,x,y)g.close()w.close()return true,n else return false,"Insufficient Funds"end else return false,"Incorrect Pin"end end end;function a.checkPin(d,f)local z=false;if not d or not f then return z end;local g=fs.open("account/"..d,"r+")if g~=nil then local n=tonumber(g.readLine())local o=g.readLine()if f==o then z=true end;g.close()return z else return false end end;function a.checkCard(d)local z=false;if not d then return z end;local g=fs.open("account/"..d,"r")if g~=nil then z=true;g.close()end;return z end;function a.createAccount(d,f)if not d or not f then return false,"Account number and PIN are required"end;local g=nil;g=fs.open("account/"..d,"r")if g~=nil then g.close()return false,"Account already exists"end;local e=0;g=fs.open("account/"..d,"w")g.writeLine(e)g.writeLine(f)g.close()return true,"Account created successfully"end;return a
